"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[774],{2099:(e,t,n)=>{n.d(t,{HW:()=>i,ND:()=>r,Ru:()=>a,sh:()=>o});let r=(0,n(5647).UU)("https://zusheijhebsmjiyyeiqq.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1c2hlaWpoZWJzbWppeXllaXFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4MjI0NDAsImV4cCI6MjA2NzM5ODQ0MH0.iwGPaOJPa6OvwX_iA1xvRt5cM72DWfd8Br1pwRTemRc"),a=async(e,t)=>{let{data:n,error:a}=await r.auth.signInWithPassword({email:e,password:t});return{data:n,error:a}},i=async()=>{let{data:{user:e}}=await r.auth.getUser();return e},o=async()=>{let{data:{user:e}}=await r.auth.getUser();if(console.log("Auth user:",e),!e)return console.log("No authenticated user found"),null;let{data:t,error:n}=await r.from("users").select("*").eq("auth_id",e.id).single();return(console.log("User profile query result:",{userProfile:t,error:n}),n)?(console.error("Error fetching user profile:",n),null):(console.log("Returning user profile:",t),t)}},8393:(e,t,n)=>{n.d(t,{QE:()=>a,uE:()=>u,bG:()=>d,DW:()=>c});var r=n(2099);async function a(){let e=new Date,t=e.getFullYear().toString().slice(-2),n=(e.getMonth()+1).toString().padStart(2,"0");try{let e="",a=!1,i=0;for(;!a&&i<1e3;){let o=Math.floor(1e4*Math.random()).toString().padStart(4,"0");e="AH".concat(t).concat(n).concat(o);let{data:s,error:l}=await r.ND.from("patients").select("patient_id").eq("patient_id",e).single();if(l&&"PGRST116"===l.code)a=!0;else if(l)throw console.error("Error checking UHID uniqueness:",l),Error("Failed to generate UHID");i++}if(!a)throw Error("Failed to generate unique UHID after maximum attempts");return e}catch(e){throw console.error("Error generating UHID:",e),Error("Failed to generate UHID")}}async function i(e){let t="".concat(e,"@annam.com"),n="password";try{let{data:a,error:i}=await r.ND.auth.signUp({email:t,password:n,options:{emailRedirectTo:"".concat(window.location.origin,"/auth/callback"),data:{role:"patient",uhid:e,email_confirm:!0}}});if(i)throw console.error("Error creating auth user:",i),Error("Failed to create authentication: ".concat(i.message));return{authUser:a.user,credentials:{email:t,password:n}}}catch(e){throw console.error("Error creating patient auth credentials:",e),e}}async function o(e,t,n){try{let a="".concat(t.firstName," ").concat(t.lastName);!function(e){let t=new Date,n=t.getFullYear().toString(),r=(t.getMonth()+1).toString().padStart(2,"0"),a=t.getTime().toString().slice(-4);"BARS".concat(n).concat(r).concat(a)}(0);let i=null;t.admissionDate&&(i=t.admissionTime?"".concat(t.admissionDate,"T").concat(t.admissionTime):"".concat(t.admissionDate,"T00:00:00"));let o={patient_id:e,name:a,date_of_birth:t.dateOfBirth,gender:t.gender.toLowerCase(),marital_status:t.maritalStatus||null,phone:t.phone,email:t.email||"".concat(e,"@annam.com"),address:t.address,blood_group:t.bloodGroup||null,allergies:t.allergies||null,medical_history:t.medicalHistory||null,current_medications:t.currentMedications||null,chronic_conditions:t.chronicConditions||null,previous_surgeries:t.previousSurgeries||null,admission_date:i,admission_time:t.admissionTime||null,primary_complaint:t.primaryComplaint,admission_type:t.admissionType,referring_doctor_facility:t.referringDoctorFacility||null,department_ward:t.departmentWard||null,room_number:t.roomNumber||null,guardian_name:t.guardianName||null,guardian_relationship:t.guardianRelationship||null,guardian_phone:t.guardianPhone||null,guardian_address:t.guardianAddress||null,emergency_contact_name:t.emergencyContactName||null,emergency_contact_phone:t.emergencyContactPhone||null,emergency_contact_relationship:t.emergencyContactRelationship||null,insurance_number:t.insuranceNumber||null,insurance_provider:t.insuranceProvider||null,initial_symptoms:t.initialSymptoms||null,referred_by:t.referredBy||null,user_id:n||null,status:"active"},{data:s,error:l}=await r.ND.from("patients").insert([o]).select().single();if(l)throw console.error("Error inserting patient record:",l),Error("Failed to create patient record: ".concat(l.message));return s}catch(e){throw console.error("Error inserting patient record:",e),e}}async function s(e,t,n){try{let a="".concat(n.firstName," ").concat(n.lastName),i={auth_id:e,employee_id:t,name:a,email:n.email||"".concat(t,"@annam.com"),role:"patient",phone:n.phone,address:n.address,status:"active",permissions:{patient_portal:!0,view_own_records:!0,book_appointments:!0}},{data:o,error:s}=await r.ND.from("users").insert([i]).select().single();if(s)throw console.error("Error linking auth user to patient:",s),Error("Failed to create user record: ".concat(s.message));return o}catch(e){throw console.error("Error linking auth user to patient:",e),e}}async function l(e,t){try{var n,a;if(!(null==(n=t.initialSymptoms)?void 0:n.trim())&&!(null==(a=t.primaryComplaint)?void 0:a.trim()))return null;let i="APT".concat(Date.now()),o=new Date;o.setDate(o.getDate()+1);let s={appointment_id:i,patient_id:e,appointment_date:o.toISOString().split("T")[0],appointment_time:"09:00:00",type:"consultation",status:"scheduled",symptoms:t.initialSymptoms||t.primaryComplaint,notes:"Initial consultation for newly registered patient. Primary complaint: ".concat(t.primaryComplaint)},{data:l,error:c}=await r.ND.from("appointments").insert([s]).select().single();if(c)return console.error("Error creating initial appointment:",c),null;return l}catch(e){return console.error("Error creating initial appointment:",e),null}}async function c(e,t){try{var n,r;let c=t||await a();console.log("Using UHID:",c);let{authUser:d,credentials:u}=await i(c);console.log("Created auth user:",null==d?void 0:d.id);let m=await s(d.id,c,e);console.log("Created user record:",m.id);let p=await o(c,e,m.id);if(console.log("Created patient record:",p.id),(null==(n=e.initialSymptoms)?void 0:n.trim())||(null==(r=e.primaryComplaint)?void 0:r.trim())){let t=await l(p.id,e);t&&console.log("Created initial appointment:",t.id)}return{success:!0,patient:p,uhid:c,credentials:u}}catch(e){return console.error("Error registering new patient:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function d(e){try{let{data:t,error:n}=await r.ND.from("patients").select("\n        *,\n        users:user_id (\n          id,\n          name,\n          email,\n          role,\n          status,\n          permissions\n        ),\n        appointments:appointments(\n          id,\n          appointment_id,\n          appointment_date,\n          appointment_time,\n          type,\n          status,\n          symptoms,\n          diagnosis,\n          doctor:doctors(\n            id,\n            user:users(name, specialization)\n          )\n        ),\n        bed_allocations:bed_allocations(\n          id,\n          admission_date,\n          discharge_date,\n          admission_type,\n          status,\n          bed:beds(bed_number, room_number, bed_type),\n          doctor:doctors(\n            id,\n            user:users(name, specialization)\n          )\n        )\n      ").eq("patient_id",e).single();if(n)throw console.error("Error fetching patient with related data:",n),Error("Patient not found: ".concat(n.message));return t}catch(e){throw console.error("Error fetching patient with related data:",e),e}}async function u(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{let{page:t=1,limit:n=20,status:a,searchTerm:i}=e,o=(t-1)*n,s=r.ND.from("patients").select("\n        *,\n        users:user_id (\n          id,\n          name,\n          email,\n          role,\n          status,\n          permissions\n        )\n      ",{count:"exact"});a&&(s=s.eq("status",a)),i&&(s=s.or("name.ilike.%".concat(i,"%,patient_id.ilike.%").concat(i,"%,phone.ilike.%").concat(i,"%")));let{data:l,error:c,count:d}=await s.range(o,o+n-1).order("created_at",{ascending:!1});if(c)throw console.error("Error fetching patients:",c),Error("Failed to fetch patients: ".concat(c.message));return{patients:l||[],total:d||0,page:t,limit:n}}catch(e){throw console.error("Error fetching patients:",e),e}}}}]);