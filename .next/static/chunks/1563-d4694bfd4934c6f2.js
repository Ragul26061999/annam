"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1563],{1563:(t,e,i)=>{i.d(e,{DK:()=>l,H5:()=>r,J4:()=>a,Xv:()=>s,eF:()=>c,gv:()=>m,tO:()=>u,y4:()=>_,yb:()=>o,zz:()=>d});var n=i(2099);async function a(t){try{let e=n.ND.from("medications").select("*").order("name");(null==t?void 0:t.category)&&(e=e.eq("category",t.category)),(null==t?void 0:t.prescription_required)!==void 0&&(e=e.eq("prescription_required",t.prescription_required)),(null==t?void 0:t.status)&&(e=e.eq("status",t.status)),(null==t?void 0:t.search)&&(e=e.or("name.ilike.%".concat(t.search,"%,generic_name.ilike.%").concat(t.search,"%,medication_code.ilike.%").concat(t.search,"%")));let{data:i,error:a}=await e;if(a)throw console.error("Error fetching medications:",a),a;return i||[]}catch(t){throw console.error("Error in getMedications:",t),t}}async function r(){try{let{data:t,error:e}=await n.ND.from("medications").select("*").filter("stock_quantity","lte","minimum_stock_level").eq("status","active").order("stock_quantity");if(e)throw console.error("Error fetching low stock medications:",e),e;return t||[]}catch(t){throw console.error("Error in getLowStockMedications:",t),t}}async function o(t,e,i,a,r,o,c,s){try{let d="TXN".concat(Date.now()).concat(Math.floor(1e3*Math.random())),{data:l,error:_}=await n.ND.from("pharmacy_stock_transactions").insert({medication_id:t,transaction_id:d,transaction_type:"purchase",quantity:e,unit_price:i,total_amount:e*i,batch_number:a,expiry_date:r,supplier_name:o,notes:c,created_by:s}).select("*").single();if(_)throw console.error("Error adding stock:",_),_;let{data:u}=await n.ND.from("medications").select("stock_quantity").eq("id",t).single();return u&&await n.ND.from("medications").update({stock_quantity:u.stock_quantity+e,unit_price:i,updated_at:new Date().toISOString()}).eq("id",t),l}catch(t){throw console.error("Error in addStock:",t),t}}async function c(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50;try{let a=n.ND.from("pharmacy_stock_transactions").select("*").order("created_at",{ascending:!1}).limit(i);t&&(a=a.eq("medication_id",t)),e&&(a=a.eq("transaction_type",e));let{data:r,error:o}=await a;if(o)throw console.error("Error fetching stock transactions:",o),o;return r||[]}catch(t){throw console.error("Error in getStockTransactions:",t),t}}async function s(t){try{let e=[],{data:i,error:a}=await n.ND.from("prescriptions").select("\n        id,\n        created_at,\n        doctor_id,\n        prescription_items(\n          medication_id,\n          dosage,\n          frequency,\n          duration\n        )\n      ").eq("patient_id",t).order("created_at",{ascending:!1});if(a)console.error("Error fetching prescriptions:",a);else if(i){let a=[...new Set(i.map(t=>t.doctor_id))],{data:r}=await n.ND.from("users").select("id, name").in("id",a),o=i.flatMap(t=>{var e;return(null==(e=t.prescription_items)?void 0:e.map(t=>t.medication_id))||[]}),{data:c}=await n.ND.from("medications").select("id, name, generic_name").in("id",o);i.forEach(i=>{var n;let a=null==r?void 0:r.find(t=>t.id===i.doctor_id);null==(n=i.prescription_items)||n.forEach(n=>{let r=null==c?void 0:c.find(t=>t.id===n.medication_id);e.push({id:"presc_".concat(i.id,"_").concat(n.medication_id),patient_id:t,medication_name:(null==r?void 0:r.name)||"Unknown",generic_name:(null==r?void 0:r.generic_name)||"",dosage:n.dosage||"",frequency:n.frequency||"",duration:n.duration||"",prescribed_date:i.created_at,prescribed_by:(null==a?void 0:a.name)||"Unknown Doctor",status:"prescribed"})})})}let{data:r,error:o}=await n.ND.from("prescription_dispensed").select("\n        id,\n        dispensed_at,\n        total_amount,\n        payment_status,\n        dispensed_by,\n        prescription_dispensed_items(\n          medication_id,\n          quantity_dispensed,\n          unit_price,\n          total_price\n        )\n      ").eq("patient_id",t).order("dispensed_at",{ascending:!1});if(o)console.error("Error fetching dispensed medications:",o);else if(r){let i=[...new Set(r.map(t=>t.dispensed_by))],{data:a}=await n.ND.from("users").select("id, name").in("id",i),o=r.flatMap(t=>{var e;return(null==(e=t.prescription_dispensed_items)?void 0:e.map(t=>t.medication_id))||[]}),{data:c}=await n.ND.from("medications").select("id, name, generic_name, strength, dosage_form").in("id",o);r.forEach(i=>{var n;let r=null==a?void 0:a.find(t=>t.id===i.dispensed_by);null==(n=i.prescription_dispensed_items)||n.forEach(n=>{let a=null==c?void 0:c.find(t=>t.id===n.medication_id);e.push({id:"disp_".concat(i.id,"_").concat(n.medication_id),patient_id:t,medication_name:(null==a?void 0:a.name)||"Unknown",generic_name:(null==a?void 0:a.generic_name)||"",dosage:"".concat(null==a?void 0:a.strength," ").concat(null==a?void 0:a.dosage_form)||"",frequency:"Qty: ".concat(n.quantity_dispensed),duration:"",prescribed_date:"",dispensed_date:i.dispensed_at,prescribed_by:"",dispensed_by:(null==r?void 0:r.name)||"Unknown Pharmacist",status:"dispensed",total_amount:n.total_price,payment_status:i.payment_status})})})}return e.sort((t,e)=>{let i=new Date(t.dispensed_date||t.prescribed_date);return new Date(e.dispensed_date||e.prescribed_date).getTime()-i.getTime()}),e}catch(t){throw console.error("Error in getPatientMedicationHistory:",t),t}}async function d(){try{let{count:t}=await n.ND.from("medications").select("*",{count:"exact",head:!0}).eq("status","active"),{count:e}=await n.ND.from("medications").select("*",{count:"exact",head:!0}).filter("stock_quantity","lte","minimum_stock_level").eq("status","active"),i=new Date().toISOString().split("T")[0],{data:a}=await n.ND.from("pharmacy_stock_transactions").select("total_amount").eq("transaction_type","sale").gte("created_at","".concat(i,"T00:00:00")).lt("created_at","".concat(i,"T23:59:59")),r=(null==a?void 0:a.reduce((t,e)=>t+e.total_amount,0))||0,{count:o}=await n.ND.from("pharmacy_billing").select("*",{count:"exact",head:!0}).eq("payment_status","pending"),c=new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString(),{data:s}=await n.ND.from("pharmacy_billing").select("final_amount").eq("payment_status","paid").gte("created_at",c),d=(null==s?void 0:s.reduce((t,e)=>t+e.final_amount,0))||0,{count:l}=await n.ND.from("prescription_items").select("*",{count:"exact",head:!0}).eq("status","dispensed").gte("updated_at","".concat(i,"T00:00:00")).lt("updated_at","".concat(i,"T23:59:59"));return{totalMedications:t||0,lowStockCount:e||0,todaySales:r,pendingBills:o||0,totalRevenue:d,prescriptionsDispensed:l||0}}catch(t){return console.error("Error in getPharmacyDashboardStats:",t),{totalMedications:0,lowStockCount:0,todaySales:0,pendingBills:0,totalRevenue:0,prescriptionsDispensed:0}}}async function l(){try{let{data:t,error:e}=await n.ND.from("prescriptions").select("\n        id,\n        prescription_id,\n        patient_id,\n        doctor_id,\n        issue_date,\n        status,\n        patients!inner(name),\n        users!inner(name),\n        prescription_items(\n          id,\n          medication_id,\n          medication_name,\n          quantity,\n          unit_price,\n          total_price\n        )\n      ").eq("status","pending").order("issue_date",{ascending:!1});if(e)throw console.error("Error fetching pending prescriptions:",e),e;return(t||[]).map(t=>{var e,i,n,a;return{id:t.id,prescription_id:t.prescription_id,patient_id:t.patient_id,patient_name:(null==(e=t.patients)?void 0:e.name)||"Unknown Patient",doctor_name:(null==(i=t.users)?void 0:i.name)||"Unknown Doctor",issue_date:t.issue_date,status:t.status,total_items:(null==(n=t.prescription_items)?void 0:n.length)||0,total_amount:(null==(a=t.prescription_items)?void 0:a.reduce((t,e)=>t+e.total_price,0))||0,prescription_items:t.prescription_items||[]}})}catch(t){throw console.error("Error in getPendingPrescriptions:",t),t}}async function _(t,e,i,a,r){try{let{data:o,error:c}=await n.ND.from("medications").select("stock_quantity").eq("id",t).single();if(c)throw Error("Failed to fetch medication");let s=Math.max(0,o.stock_quantity+e),{error:d}=await n.ND.from("medications").update({stock_quantity:s,updated_at:new Date().toISOString()}).eq("id",t);if(d)throw Error("Failed to update medication stock");let l="ADJ-".concat(Date.now()),{data:_,error:u}=await n.ND.from("pharmacy_stock_transactions").insert({medication_id:t,transaction_id:l,transaction_type:"adjustment",quantity:Math.abs(e),unit_price:0,total_amount:0,notes:"".concat(i,": ").concat(a),created_by:r,created_at:new Date().toISOString()}).select().single();if(u)throw Error("Failed to create stock transaction");return _}catch(t){throw console.error("Error in adjustStock:",t),t}}async function u(t,e,i,a,r,o){try{let c=e.reduce((t,e)=>t+e.quantity*e.unit_price,0),s=c*i/100,d=c-s,l=d*a/100,_=d+l,u="PH".concat(Date.now()),{data:m,error:p}=await n.ND.from("pharmacy_billing").insert({bill_number:u,patient_id:t,subtotal:c,discount:s,tax_amount:l,tax_rate:a,final_amount:_,payment_method:r,payment_status:"paid",created_by:o,created_at:new Date().toISOString()}).select().single();if(p)throw Error("Failed to create pharmacy bill");for(let t of e){await n.ND.from("pharmacy_bill_items").insert({bill_id:m.id,medication_id:t.medication_id,quantity:t.quantity,unit_price:t.unit_price,total_price:t.quantity*t.unit_price});let{data:e}=await n.ND.from("medications").select("stock_quantity").eq("id",t.medication_id).single();if(e){let i=Math.max(0,e.stock_quantity-t.quantity);await n.ND.from("medications").update({stock_quantity:i}).eq("id",t.medication_id);let a="SALE-".concat(Date.now(),"-").concat(t.medication_id);await n.ND.from("pharmacy_stock_transactions").insert({medication_id:t.medication_id,transaction_id:a,transaction_type:"sale",quantity:t.quantity,unit_price:t.unit_price,total_amount:t.quantity*t.unit_price,notes:"Sold via bill ".concat(u),created_by:o,created_at:new Date().toISOString()})}}return{...m,total_amount:_,items:e.map(t=>({medication_id:t.medication_id,quantity:t.quantity,unit_price:t.unit_price,total_price:t.quantity*t.unit_price}))}}catch(t){throw console.error("Error in createPharmacyBill:",t),t}}async function m(t){try{let e=n.ND.from("pharmacy_billing").select("\n        *,\n        patient:patients(first_name, last_name)\n      ").order("created_at",{ascending:!1});t&&(e=e.eq("patient_id",t));let{data:i,error:a}=await e;if(a)return console.error("Error fetching pharmacy bills:",a),[];return(null==i?void 0:i.map(t=>({...t,patient_name:t.patient?"".concat(t.patient.first_name," ").concat(t.patient.last_name):"Unknown",total_amount:t.final_amount,items:[]})))||[]}catch(t){return console.error("Error in getPharmacyBills:",t),[]}}}}]);